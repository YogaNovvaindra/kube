apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-alerts-infra
  namespace: monitoring
data:
  alerts-infra.yaml: |
    apiVersion: 1
    groups:
      - orgId: 1
        name: Infrastructure
        folder: Infra Alerts
        interval: 5m
        rules:
          - uid: target_down
            title: Monitoring Target Down
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: prometheus
                model:
                  datasource: { type: prometheus, uid: prometheus }
                  expr: 'up'
                  refId: A
              - refId: B
                datasourceUid: __expr__
                model:
                  datasource: { type: __expr__, uid: __expr__ }
                  expression: A
                  reducer: mean
                  refId: B
                  type: reduce
              - refId: C
                datasourceUid: __expr__
                model:
                  datasource: { type: __expr__, uid: __expr__ }
                  expression: B
                  refId: C
                  type: threshold
                  conditions:
                    - evaluator: { params: [1], type: lt }
                      operator: { type: and }
                      query: { params: [C] }
                      reducer: { params: [], type: last }
                      type: query
            for: 5m
            annotations:
              summary: "Target Down: {{ $labels.job }}"
              description: "Monitoring target {{ $labels.instance }} (job: {{ $labels.job }}) is unreachable."
            labels:
              severity: critical

          - uid: traefik_high_error_rate
            title: Traefik High Error Rate
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: prometheus
                model:
                  datasource: { type: prometheus, uid: prometheus }
                  expr: '(sum(rate(traefik_entrypoint_requests_total{code=~"5.."}[5m])) or vector(0)) / sum(rate(traefik_entrypoint_requests_total[5m])) * 100'
                  refId: A
              - refId: B
                datasourceUid: __expr__
                model:
                  datasource: { type: __expr__, uid: __expr__ }
                  expression: A
                  reducer: mean
                  refId: B
                  type: reduce
              - refId: C
                datasourceUid: __expr__
                model:
                  datasource: { type: __expr__, uid: __expr__ }
                  expression: B
                  refId: C
                  type: threshold
                  conditions:
                    - evaluator: { params: [5], type: gt }
                      operator: { type: and }
                      query: { params: [C] }
                      reducer: { params: [], type: last }
                      type: query
            for: 5m
            annotations:
              summary: "High HTTP 5xx Error Rate"
              description: "Traefik is reporting a high rate of 5xx errors (Current: {{ $values.B.Value | printf \"%.2f\" }}%)."
            labels:
              severity: warning

          - uid: authentik_worker_absent
            title: Authentik Worker Absent
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: prometheus
                model:
                  datasource: { type: prometheus, uid: prometheus }
                  expr: 'sum(authentik_tasks_workers) or vector(0)'
                  refId: A
              - refId: B
                datasourceUid: __expr__
                model:
                  datasource: { type: __expr__, uid: __expr__ }
                  expression: A
                  reducer: mean
                  refId: B
                  type: reduce
              - refId: C
                datasourceUid: __expr__
                model:
                  datasource: { type: __expr__, uid: __expr__ }
                  expression: B
                  refId: C
                  type: threshold
                  conditions:
                    - evaluator: { params: [1], type: lt }
                      operator: { type: and }
                      query: { params: [C] }
                      reducer: { params: [], type: last }
                      type: query
            for: 5m
            annotations:
              summary: "Authentik Workers: {{ $values.B.Value | printf \"%.0f\" }}"
              description: "Number of active Authentik workers is {{ $values.B.Value | printf \"%.0f\" }}."
            labels:
              severity: critical
