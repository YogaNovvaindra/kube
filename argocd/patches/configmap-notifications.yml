apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  $patch: merge
  # Discord service configuration using generic webhook
  service.webhook.discord: |
    url: $discord-webhook-url
    headers:
      - name: Content-Type
        value: application/json

  # Template for successful sync
  template.app-sync-succeeded: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "‚úÖ Application Synced Successfully",
                "description": "**{{.app.metadata.name}}** has been synced successfully.",
                "color": 3066993,
                "fields": [
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  },
                  {
                    "name": "Health Status",
                    "value": "{{.app.status.health.status}}",
                    "inline": true
                  },
                  {
                    "name": "Revision",
                    "value": "{{.app.status.sync.revision}}",
                    "inline": false
                  }
                ],
                "timestamp": "{{.app.status.operationState.finishedAt}}"
              }
            ]
          }

  # Template for failed sync
  template.app-sync-failed: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "‚ùå Application Sync Failed",
                "description": "**{{.app.metadata.name}}** sync has failed.",
                "color": 15158332,
                "fields": [
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  },
                  {
                    "name": "Health Status",
                    "value": "{{.app.status.health.status}}",
                    "inline": true
                  },
                  {
                    "name": "Error",
                    "value": "{{.app.status.operationState.message}}",
                    "inline": false
                  }
                ],
                "timestamp": "{{.app.status.operationState.finishedAt}}"
              }
            ]
          }

  # Template for health degraded
  template.app-health-degraded: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "‚ö†Ô∏è Application Health Degraded",
                "description": "**{{.app.metadata.name}}** health status is degraded.",
                "color": 16776960,
                "fields": [
                  {
                    "name": "Health Status",
                    "value": "{{.app.status.health.status}}",
                    "inline": true
                  },
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  }
                ],
                "timestamp": "{{time.Now}}"
              }
            ]
          }

  # Template for sync running
  template.app-sync-running: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "üîÑ Application Sync Started",
                "description": "**{{.app.metadata.name}}** sync is in progress.",
                "color": 3447003,
                "fields": [
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  },
                  {
                    "name": "Initiated By",
                    "value": "{{.app.status.operationState.operation.initiatedBy.username}}",
                    "inline": true
                  }
                ],
                "timestamp": "{{.app.status.operationState.startedAt}}"
              }
            ]
          }

  # Trigger for sync succeeded
  trigger.on-sync-succeeded: |
    - when: app.status.operationState.phase in ['Succeeded']
      send: [app-sync-succeeded]

  # Trigger for sync failed
  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error', 'Failed']
      send: [app-sync-failed]

  # Trigger for health degraded
  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [app-health-degraded]

  # Trigger for sync running
  trigger.on-sync-running: |
    - when: app.status.operationState.phase in ['Running']
      send: [app-sync-running]
