apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  $patch: merge
  # Discord service configuration using generic webhook
  service.webhook.discord: |
    url: $discord-webhook-url
    headers:
      - name: Content-Type
        value: application/json

  # Template for successful sync
  template.app-sync-succeeded: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "‚úÖ {{.app.metadata.name}} | Synced Successfully",
                "url": "https://argocd.ygnv.my.id/applications/{{.app.metadata.name}}",
                "color": 4358529,
                "description": "Application synced to revision **{{.app.status.sync.revision}}**",
                "fields": [
                  {
                    "name": "Health Status",
                    "value": "{{.app.status.health.status}}",
                    "inline": true
                  },
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "ArgoCD Notification"
                },
                "timestamp": "{{.app.status.operationState.finishedAt}}"
              }
            ]
          }

  # Template for failed sync
  template.app-sync-failed: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "‚ùå {{.app.metadata.name}} | Sync Failed",
                "url": "https://argocd.ygnv.my.id/applications/{{.app.metadata.name}}",
                "color": 15158332,
                "description": "Sync failed with error:\n```{{.app.status.operationState.message}}```",
                "fields": [
                  {
                    "name": "Health Status",
                    "value": "{{.app.status.health.status}}",
                    "inline": true
                  },
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  }
                ],
                 "footer": {
                  "text": "ArgoCD Notification"
                },
                "timestamp": "{{.app.status.operationState.finishedAt}}"
              }
            ]
          }

  # Template for health degraded
  template.app-health-degraded: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "‚ö†Ô∏è {{.app.metadata.name}} | Health Degraded",
                "url": "https://argocd.ygnv.my.id/applications/{{.app.metadata.name}}",
                "color": 16776960,
                "fields": [
                  {
                    "name": "Health Status",
                    "value": "{{.app.status.health.status}}",
                    "inline": true
                  },
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  }
                ],
                 "footer": {
                  "text": "ArgoCD Notification"
                },
                "timestamp": "{{.app.metadata.creationTimestamp}}"
              }
            ]
          }

  # Template for sync running
  template.app-sync-running: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "üîÑ {{.app.metadata.name}} | Sync Started",
                "url": "https://argocd.ygnv.my.id/applications/{{.app.metadata.name}}",
                "color": 3447003,
                "description": "Sync operation initiated by **{{.app.status.operationState.operation.initiatedBy.username}}**",
                "fields": [
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  }
                ],
                 "footer": {
                  "text": "ArgoCD Notification"
                },
                "timestamp": "{{.app.status.operationState.startedAt}}"
              }
            ]
          }

  # Trigger for sync succeeded
  trigger.on-sync-succeeded: |
    - when: app.status.operationState.phase in ['Succeeded']
      send: [app-sync-succeeded]

  # Trigger for sync failed
  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error', 'Failed']
      send: [app-sync-failed]

  # Trigger for health degraded
  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [app-health-degraded]

  # Trigger for sync running
  trigger.on-sync-running: |
    - when: app.status.operationState.phase in ['Running']
      send: [app-sync-running]
