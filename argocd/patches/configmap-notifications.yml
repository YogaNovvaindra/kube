apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  $patch: merge
  # Discord service configuration using generic webhook
  service.webhook.discord: |
    url: $discord-webhook-url
    headers:
      - name: Content-Type
        value: application/json

  subscriptions: |
    - recipients:
      - discord
      triggers:
      - on-sync-succeeded
      - on-sync-failed
      - on-health-degraded
      - on-sync-running
      - on-app-error

  # Template for successful sync
  template.app-sync-succeeded: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "âœ… Application Synced Successfully",
                "url": "https://argocd.ygnv.my.id/applications/{{.app.metadata.name}}",
                "color": 4358529,
                "description": "**{{.app.metadata.name}}** has been synced successfully.",
                "fields": [
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  },
                  {
                    "name": "Health Status",
                    "value": "{{.app.status.health.status}}",
                    "inline": true
                  },
                  {
                    "name": "Initiated By",
                    "value": "{{ if .app.status.operationState.operation.initiatedBy.username }}{{ .app.status.operationState.operation.initiatedBy.username }}{{ else }}Automatic{{ end }}",
                    "inline": true
                  },
                  {
                    "name": "Repository",
                    "value": "{{.app.spec.source.repoURL}}",
                    "inline": false
                  },
                  {
                    "name": "Revision",
                    "value": "{{.app.spec.source.targetRevision}}",
                    "inline": true
                  },
                  {
                    "name": "Synced Commit",
                    "value": "{{.app.status.sync.revision}}",
                    "inline": true
                  },
                  {
                    "name": "Changes",
                    "value": "{{ with $c := call .repo.GetCommitMetadata .app.status.sync.revision }}{{ $c.Message }} - {{ $c.Author }}{{ end }}",
                    "inline": false
                  },
                  {
                    "name": "Updated Resources",
                    "value": "```{{ range .app.status.operationState.syncResult.resources }}{{ .kind }}/{{ .name }}: {{ .status }}\\n{{ end }}```",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "ArgoCD Notification â€¢ {{.app.status.operationState.finishedAt}}"
                },
                "timestamp": "{{.app.status.operationState.finishedAt}}"
              }
            ]
          }

  # Template for failed sync
  template.app-sync-failed: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "âŒ Application Sync Failed",
                "url": "https://argocd.ygnv.my.id/applications/{{.app.metadata.name}}",
                "color": 15158332,
                "description": "**{{.app.metadata.name}}** sync failed.",
                "fields": [
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  },
                  {
                    "name": "Health Status",
                    "value": "{{.app.status.health.status}}",
                    "inline": true
                  },
                  {
                    "name": "Initiated By",
                    "value": "{{ if .app.status.operationState.operation.initiatedBy.username }}{{ .app.status.operationState.operation.initiatedBy.username }}{{ else }}Automatic{{ end }}",
                    "inline": true
                  },
                  {
                    "name": "Repository",
                    "value": "{{.app.spec.source.repoURL}}",
                    "inline": false
                  },
                   {
                    "name": "Changes",
                    "value": "{{ with $c := call .repo.GetCommitMetadata .app.status.sync.revision }}{{ $c.Message }} - {{ $c.Author }}{{ end }}",
                    "inline": false
                  },
                  {
                    "name": "Updated Resources",
                    "value": "```{{ range .app.status.operationState.syncResult.resources }}{{ printf \"%s/%s: %s\\n\" .kind .name .status }}{{ end }}```",
                    "inline": false
                  },
                  {
                    "name": "Error",
                    "value": {{ if .app.status.operationState.message }}{{ printf "```%s```" .app.status.operationState.message | toJson }}{{ else if .app.status.operationState.syncResult }}{{ range .app.status.operationState.syncResult.resources }}{{ if not (eq .status "Synced") }}{{ printf "```%s: %s```" .name .message | toJson }}{{ end }}{{ end }}{{ else }}"Unknown Sync Error"{{ end }},
                    "inline": false
                  }
                ],
                 "footer": {
                  "text": "ArgoCD Notification â€¢ {{.app.status.operationState.finishedAt}}"
                },
                "timestamp": "{{.app.status.operationState.finishedAt}}"
              }
            ]
          }

  # Template for health degraded
  template.app-health-degraded: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "âš ï¸ Application Health Degraded",
                "url": "https://argocd.ygnv.my.id/applications/{{.app.metadata.name}}",
                "color": 16776960,
                "description": "**{{.app.metadata.name}}** health status is degraded.",
                "fields": [
                  {
                    "name": "Health Status",
                    "value": "{{.app.status.health.status}}",
                    "inline": true
                  },
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  },
                  {
                    "name": "Repository",
                    "value": "{{.app.spec.source.repoURL}}",
                    "inline": false
                  },
                   {
                    "name": "Changes",
                    "value": "{{ with $c := call .repo.GetCommitMetadata .app.status.sync.revision }}{{ $c.Message }} - {{ $c.Author }}{{ end }}",
                    "inline": false
                  },
                  {
                    "name": "Degraded Resources",
                    "value": "```{{ range .app.status.resources }}{{ if .health }}{{ if ne .health.status \"Healthy\" }}{{ printf \"%s/%s: %s\\n\" .kind .name .health.status }}{{ end }}{{ end }}{{ end }}```",
                    "inline": false
                  },
                  {
                    "name": "Reason",
                    "value": "{{ if .app.status.health.message }}{{ .app.status.health.message }}{{ else }}{{ $found := false }}{{ range .app.status.resources }}{{ if .health }}{{ if ne .health.status "Healthy" }}{{ .name }}: {{ .health.status }}{{ if .health.message }} ({{ .health.message }}){{ end }}\\n{{ $found = true }}{{ end }}{{ end }}{{ end }}{{ if not $found }}Application is Degraded. Specific resource health details may be omitted from the Application status (Review in ArgoCD UI for full details).{{ end }}{{ end }}",
                    "inline": false
                  }
                ],
                 "footer": {
                  "text": "ArgoCD Notification"
                },
                "timestamp": "{{.app.metadata.creationTimestamp}}"
              }
            ]
          }

  # Template for sync running
  template.app-sync-running: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "ðŸ”„ Application Sync Started",
                "url": "https://argocd.ygnv.my.id/applications/{{.app.metadata.name}}",
                "color": 3447003,
                "description": "**{{.app.metadata.name}}** sync is in progress.",
                "fields": [
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  },
                  {
                    "name": "Initiated By",
                    "value": "{{ if .app.status.operationState.operation.initiatedBy.username }}{{ .app.status.operationState.operation.initiatedBy.username }}{{ else }}Automatic{{ end }}",
                    "inline": true
                  },
                  {
                    "name": "Repository",
                    "value": "{{.app.spec.source.repoURL}}",
                    "inline": false
                  },
                  {
                    "name": "Revision",
                    "value": "{{.app.spec.source.targetRevision}}",
                    "inline": true
                  }
                ],
                 "footer": {
                  "text": "ArgoCD Notification â€¢ {{.app.status.operationState.startedAt}}"
                },
                "timestamp": "{{.app.status.operationState.startedAt}}"
              }
            ]
          }

  # Template for application error (comparison error, etc)
  template.app-error: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "ðŸš¨ Application Error",
                "url": "https://argocd.ygnv.my.id/applications/{{.app.metadata.name}}",
                "color": 15548997,
                "description": "**{{.app.metadata.name}}** has an application error.",
                "fields": [
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  },
                  {
                    "name": "Health Status",
                    "value": "{{.app.status.health.status}}",
                    "inline": true
                  },
                  {
                    "name": "Error Conditions",
                    "value": "```{{ range .app.status.conditions }}{{ .type }}: {{ .message }}\\n{{ end }}```",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "ArgoCD Notification"
                },
                "timestamp": "{{.app.metadata.creationTimestamp}}"
              }
            ]
          }

  # Trigger for sync succeeded
  trigger.on-sync-succeeded: |
    - oncePer: app.status.operationState.syncResult.revision
      when: app.status.operationState.phase in ['Succeeded']
      send: [app-sync-succeeded]

  # Trigger for sync failed
  trigger.on-sync-failed: |
    - oncePer: app.status.operationState.syncResult.revision
      when: app.status.operationState.phase in ['Error', 'Failed', 'SyncFailed']
      send: [app-sync-failed]

  # Trigger for health degraded
  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [app-health-degraded]

  # Trigger for sync running
  trigger.on-sync-running: |
    - oncePer: app.status.operationState.syncResult.revision
      when: app.status.operationState.phase in ['Running']
      send: [app-sync-running]

  # Trigger for application error
  trigger.on-app-error: |
    - when: app.status.conditions != nil and len(app.status.conditions) > 0
      send: [app-error]
