apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  $patch: merge
  # Discord service configuration using generic webhook
  service.webhook.discord: |
    url: $discord-webhook-url
    headers:
      - name: Content-Type
        value: application/json

  # Template for successful sync
  template.app-sync-succeeded: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "‚úÖ Application Synced Successfully",
                "url": "https://argocd.ygnv.my.id/applications/{{.app.metadata.name}}",
                "color": 4358529,
                "description": "**{{.app.metadata.name}}** has been synced successfully.",
                "fields": [
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  },
                  {
                    "name": "Health Status",
                    "value": "{{.app.status.health.status}}",
                    "inline": true
                  },
                  {
                    "name": "Initiated By",
                    "value": "{{ if .app.status.operationState.operation.initiatedBy.username }}{{ .app.status.operationState.operation.initiatedBy.username }}{{ else }}Automatic{{ end }}",
                    "inline": true
                  },
                  {
                    "name": "Repository",
                    "value": "{{.app.spec.source.repoURL}}",
                    "inline": false
                  },
                  {
                    "name": "Revision",
                    "value": "{{.app.spec.source.targetRevision}}",
                    "inline": true
                  },
                  {
                    "name": "Synced Commit",
                    "value": "{{.app.status.sync.revision}}",
                    "inline": true
                  },
                  {
                    "name": "Changes",
                    "value": "{{ with $c := call .repo.GetCommitMetadata .app.status.sync.revision }}{{ $c.Message }} - {{ $c.Author }}{{ end }}",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "ArgoCD Notification ‚Ä¢ {{.app.status.operationState.finishedAt}}"
                },
                "timestamp": "{{.app.status.operationState.finishedAt}}"
              }
            ]
          }

  # Template for failed sync
  template.app-sync-failed: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "‚ùå Application Sync Failed",
                "url": "https://argocd.ygnv.my.id/applications/{{.app.metadata.name}}",
                "color": 15158332,
                "description": "**{{.app.metadata.name}}** sync failed.",
                "fields": [
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  },
                  {
                    "name": "Health Status",
                    "value": "{{.app.status.health.status}}",
                    "inline": true
                  },
                  {
                    "name": "Initiated By",
                    "value": "{{ if .app.status.operationState.operation.initiatedBy.username }}{{ .app.status.operationState.operation.initiatedBy.username }}{{ else }}Automatic{{ end }}",
                    "inline": true
                  },
                  {
                    "name": "Repository",
                    "value": "{{.app.spec.source.repoURL}}",
                    "inline": false
                  },
                   {
                    "name": "Changes",
                    "value": "{{ with $c := call .repo.GetCommitMetadata .app.status.sync.revision }}{{ $c.Message }} - {{ $c.Author }}{{ end }}",
                    "inline": false
                  },
                  {
                    "name": "Error",
                    "value": "```{{ if .app.status.operationState.message }}{{ .app.status.operationState.message }}{{ else }}{{ range .app.status.operationState.syncResult.resources }}{{ if not (eq .status "Synced") }}{{ .name }}: {{ .message }}\\n{{ end }}{{ end }}{{ end }}```",
                    "inline": false
                  }
                ],
                 "footer": {
                  "text": "ArgoCD Notification ‚Ä¢ {{.app.status.operationState.finishedAt}}"
                },
                "timestamp": "{{.app.status.operationState.finishedAt}}"
              }
            ]
          }

  # Template for health degraded
  template.app-health-degraded: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "‚ö†Ô∏è Application Health Degraded",
                "url": "https://argocd.ygnv.my.id/applications/{{.app.metadata.name}}",
                "color": 16776960,
                "description": "**{{.app.metadata.name}}** health status is degraded.",
                "fields": [
                  {
                    "name": "Health Status",
                    "value": "{{.app.status.health.status}}",
                    "inline": true
                  },
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  },
                  {
                    "name": "Repository",
                    "value": "{{.app.spec.source.repoURL}}",
                    "inline": false
                  },
                   {
                    "name": "Changes",
                    "value": "{{ with $c := call .repo.GetCommitMetadata .app.status.sync.revision }}{{ $c.Message }} - {{ $c.Author }}{{ end }}",
                    "inline": false
                  },
                  {
                    "name": "Reason",
                    "value": "{{ if .app.status.health.message }}{{ .app.status.health.message }}{{ else }}{{ range .app.status.resources }}{{ if eq .health.status "Degraded" }}{{ .name }}: {{ .health.message | default "Degraded" }}\\n{{ end }}{{ end }}{{ end }}",
                    "inline": false
                  }
                ],
                 "footer": {
                  "text": "ArgoCD Notification"
                },
                "timestamp": "{{.app.metadata.creationTimestamp}}"
              }
            ]
          }

  # Template for sync running
  template.app-sync-running: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "username": "ArgoCD",
            "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/logo.png",
            "embeds": [
              {
                "title": "üîÑ Application Sync Started",
                "url": "https://argocd.ygnv.my.id/applications/{{.app.metadata.name}}",
                "color": 3447003,
                "description": "**{{.app.metadata.name}}** sync is in progress.",
                "fields": [
                  {
                    "name": "Sync Status",
                    "value": "{{.app.status.sync.status}}",
                    "inline": true
                  },
                  {
                    "name": "Initiated By",
                    "value": "{{ if .app.status.operationState.operation.initiatedBy.username }}{{ .app.status.operationState.operation.initiatedBy.username }}{{ else }}Automatic{{ end }}",
                    "inline": true
                  },
                  {
                    "name": "Repository",
                    "value": "{{.app.spec.source.repoURL}}",
                    "inline": false
                  },
                  {
                    "name": "Revision",
                    "value": "{{.app.spec.source.targetRevision}}",
                    "inline": true
                  }
                ],
                 "footer": {
                  "text": "ArgoCD Notification ‚Ä¢ {{.app.status.operationState.startedAt}}"
                },
                "timestamp": "{{.app.status.operationState.startedAt}}"
              }
            ]
          }

  # Trigger for sync succeeded
  trigger.on-sync-succeeded: |
    - when: app.status.operationState.phase in ['Succeeded']
      send: [app-sync-succeeded]

  # Trigger for sync failed
  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error', 'Failed']
      send: [app-sync-failed]

  # Trigger for health degraded
  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [app-health-degraded]

  # Trigger for sync running
  trigger.on-sync-running: |
    - when: app.status.operationState.phase in ['Running']
      send: [app-sync-running]
