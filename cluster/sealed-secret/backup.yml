apiVersion: batch/v1
kind: CronJob
metadata:
  name: sealed-secrets-backup
  namespace: cluster
spec:
  schedule: "30 0 * * *" # 0:30 AM daily
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: default # Use default SA with RBAC permissions
          containers:
            - name: sealed-secrets-backup
              image: reg.ygnv.my.id/docker/alpine/kubectl:1.34.2
              command:
                - /bin/sh
                - -c
                - |
                  set -eo pipefail
                  BACKUP_DIR="/backup"

                  PRIVATE_KEY=$(kubectl get secret -n cluster \
                    -l sealedsecrets.bitnami.com/sealed-secrets-key=active \
                    -o name)

                  kubectl get -n cluster ${PRIVATE_KEY} -o yaml \
                    > ${BACKUP_DIR}/sealed-secrets-key-$(date +%Y%m%d-%H%M%S).yml

                  # Rotate backups - keep last 3
                  ls -1t /backup/sealed-secrets-key-*.yml | tail -n +4 | xargs -r rm -f
              volumeMounts:
                - name: backup-volume
                  mountPath: /backup
          restartPolicy: Never
          volumes:
            - name: backup-volume
              hostPath:
                path: /mnt/cephfs/docker/cluster/sealed-secret
                type: Directory
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: sealed-secrets-backup
  namespace: cluster
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: view
subjects:
  - kind: ServiceAccount
    name: default
    namespace: cluster
